// RÃ¨gles Firestore pour la feature Stories
// Ã€ intÃ©grer dans firestore.rules principal

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ðŸŽ¬ STORIES
    // ============================================
    match /stories/{storyId} {
      
      // Lecture: stories actives uniquement, non expirÃ©es
      allow read: if resource.data.status == 'active' 
        && request.time < resource.data.expiresAt;
      
      // CrÃ©ation: user authentifiÃ©, userId = auth.uid
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.createdAt == request.time
        && request.resource.data.expiresAt == request.time + duration.value(24, 'h')
        && request.resource.data.status == 'active';
      
      // Mise Ã  jour: compteurs uniquement (par Cloud Functions)
      allow update: if false; // Seules les Functions peuvent update
      
      // Suppression: propriÃ©taire uniquement (soft delete status='deleted')
      allow delete: if request.auth.uid == resource.data.userId;
      
      // ============================================
      // ðŸŽ¬ VIEWERS (qui a vu la story)
      // ============================================
      match /viewers/{viewerId} {
        // Ã‰criture: user enregistre sa propre vue
        allow create: if request.auth.uid == viewerId
          && request.resource.data.viewedAt == request.time;
        
        allow update: if request.auth.uid == viewerId;
        
        // Lecture: propriÃ©taire de la story uniquement
        allow read: if request.auth.uid == get(/databases/$(database)/documents/stories/$(storyId)).data.userId;
      }
    }
    
    // ============================================
    // ðŸ“± FEED STORIES UTILISATEUR (dÃ©normalisÃ©)
    // ============================================
    match /users/{userId}/stories_feed/{storyId} {
      // Lecture: owner uniquement
      allow read: if request.auth.uid == userId;
      
      // Ã‰criture: Cloud Functions uniquement (fanout)
      allow write: if false;
    }
    
    // ============================================
    // ðŸ‘¤ STORIES D'UN USER (index)
    // ============================================
    match /users/{userId}/stories/{storyId} {
      // Lecture: public
      allow read: if true;
      
      // Ã‰criture: Cloud Functions uniquement
      allow write: if false;
    }
    
  }
}

// ============================================
// ðŸ” RÃˆGLES STORAGE (stories mÃ©dias)
// ============================================
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Stories mÃ©dias
    match /stories/{userId}/{mediaId} {
      // Upload: user authentifiÃ©, son propre dossier
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size < 100 * 1024 * 1024 // Max 100MB
        && (request.resource.contentType.matches('image/.*') 
           || request.resource.contentType.matches('video/.*'));
      
      // Lecture: public (si URL partagÃ©e)
      allow read: if true;
      
      // Suppression: propriÃ©taire ou Cloud Function
      allow delete: if request.auth.uid == userId;
    }
    
  }
}
