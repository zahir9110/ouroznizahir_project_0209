rules_version='2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ðŸ” BÅŒKEN - RÃˆGLES D'AUTORISATION RBAC
    // ============================================
    
    // === HELPER FUNCTIONS ===
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user';
    }
    
    function isOrganizer() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'organizer';
    }
    
    function isUserOrOrganizer() {
      return isUser() || isOrganizer();
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // === COLLECTION RULES ===
    
    // Collection: users
    match /users/{userId} {
      // Tout le monde peut lire les profils publics (pour afficher auteurs d'avis, etc.)
      allow read: if true;
      
      // Seul l'utilisateur peut crÃ©er/modifier son propre profil
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      
      // Pas de suppression directe (soft delete via Cloud Functions)
      allow delete: if false;
    }
    
    // Collection: places
    match /places/{placeId} {
      // âœ… GUEST: Lecture libre des lieux publiÃ©s
      allow read: if resource.data.isPublished == true;
      
      // âœ… ORGANIZER: Peut lire ses propres lieux non publiÃ©s
      allow read: if isOrganizer() && resource.data.organizerId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut crÃ©er des lieux
      allow create: if isOrganizer();
      
      // âœ… ORGANIZER: Peut modifier ses propres lieux
      allow update: if isOrganizer() && resource.data.organizerId == request.auth.uid;
      
      // âŒ Pas de suppression directe
      allow delete: if false;
    }
    
    // Collection: ratings
    match /ratings/{ratingId} {
      // âœ… GUEST: Lecture libre des notes
      allow read: if true;
      
      // âœ… USER/ORGANIZER: Peut noter un lieu
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.score >= 1 && 
                       request.resource.data.score <= 5;
      
      // âœ… USER/ORGANIZER: Peut modifier sa propre note
      allow update: if isOwner(resource.data.userId);
      
      // âœ… USER/ORGANIZER: Peut supprimer sa propre note
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Collection: reviews
    match /reviews/{reviewId} {
      // âœ… GUEST: Lecture libre des avis
      allow read: if true;
      
      // âœ… USER/ORGANIZER: Peut publier un avis
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut modifier son propre avis
      allow update: if isOwner(resource.data.userId);
      
      // âœ… USER/ORGANIZER: Peut supprimer son propre avis
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Collection: messages
    match /messages/{messageId} {
      // âœ… USER/ORGANIZER: Peut lire les messages oÃ¹ il est sender OU receiver
      allow read: if isUserOrOrganizer() && 
                     (resource.data.senderId == request.auth.uid || 
                      resource.data.receiverId == request.auth.uid);
      
      // âœ… USER/ORGANIZER: Peut envoyer un message
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.senderId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut marquer comme lu (si receiver)
      allow update: if isOwner(resource.data.receiverId) && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      
      // âŒ Pas de suppression directe
      allow delete: if false;
    }
    
    // Collection: likes
    match /likes/{likeId} {
      // âœ… Lecture libre (pour compter les likes)
      allow read: if true;
      
      // âœ… USER/ORGANIZER: Peut liker
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut supprimer son propre like
      allow delete: if isOwner(resource.data.userId);
      
      // âŒ Pas de modification
      allow update: if false;
    }
    
    // Collection: comments
    match /comments/{commentId} {
      // âœ… Lecture libre
      allow read: if true;
      
      // âœ… USER/ORGANIZER: Peut commenter
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut modifier son propre commentaire
      allow update: if isOwner(resource.data.userId);
      
      // âœ… USER/ORGANIZER: Peut supprimer son propre commentaire
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Collection: shares
    match /shares/{shareId} {
      // âœ… Lecture libre (pour compter les partages)
      allow read: if true;
      
      // âœ… USER/ORGANIZER: Peut partager
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut supprimer son propre partage
      allow delete: if isOwner(resource.data.userId);
      
      // âŒ Pas de modification
      allow update: if false;
    }
    
    // Collection: favorites
    match /favorites/{favoriteId} {
      // âœ… USER/ORGANIZER: Peut lire ses propres favoris
      allow read: if isOwner(resource.data.userId);
      
      // âœ… USER/ORGANIZER: Peut sauvegarder un lieu
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut supprimer un favori
      allow delete: if isOwner(resource.data.userId);
      
      // âŒ Pas de modification
      allow update: if false;
    }
    
    // Collection: offers
    match /offers/{offerId} {
      // âœ… GUEST: Lecture libre des offres publiÃ©es
      allow read: if resource.data.isPublished == true;
      
      // âœ… ORGANIZER: Peut lire ses propres offres non publiÃ©es
      allow read: if isOrganizer() && resource.data.organizerId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut crÃ©er une offre
      allow create: if isOrganizer() && 
                       request.resource.data.organizerId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut modifier ses propres offres
      allow update: if isOrganizer() && resource.data.organizerId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut supprimer ses propres offres
      allow delete: if isOrganizer() && resource.data.organizerId == request.auth.uid;
    }
    
    // Collection: bookings
    match /bookings/{bookingId} {
      // âœ… USER/ORGANIZER: Peut lire ses propres rÃ©servations (en tant que user)
      allow read: if isUserOrOrganizer() && resource.data.userId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut lire les rÃ©servations de ses offres
      allow read: if isOrganizer() && resource.data.organizerId == request.auth.uid;
      
      // âœ… USER/ORGANIZER: Peut crÃ©er une rÃ©servation
      allow create: if isUserOrOrganizer() && 
                       request.resource.data.userId == request.auth.uid;
      
      // âœ… ORGANIZER: Peut modifier le statut des rÃ©servations de ses offres
      allow update: if isOrganizer() && 
                       resource.data.organizerId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']);
      
      // âŒ Pas de suppression directe
      allow delete: if false;
    }
  }
}
